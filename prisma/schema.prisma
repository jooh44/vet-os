generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  VET
  ATTENDANT
  TUTOR
}

model User {
  id        String   @id @default(cuid())
  name      String?
  email     String   @unique
  password  String
  role      Role     @default(ATTENDANT)

  // Relations
  tutorProfile Tutor?
  consultations Consultation[]    // If user is a Vet
  
  // Chat Relations
  sentMessages     ChatMessage[]  @relation("SentMessages")
  startedChats     ChatSession[]  @relation("VetChats")
  
  calculationLogs  CalculationLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Tutor {
  id        String   @id @default(cuid())
  cpf       String   @unique
  phone     String?
  address   String?
  
  // Compliance / Legal
  consentAccepted Boolean   @default(false)
  consentDate     DateTime?
  consentVersion  String?   // [PM Input] Track version of terms signed

  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id])
  
  pets      Pet[]
  chatSessions ChatSession[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum Species {
  DOG
  CAT
  BIRD
  OTHER
}

model Pet {
  id        String   @id @default(cuid())
  name      String
  species   Species
  breed     String?
  birthDate DateTime?
  weight    Float?   // in kg
  photoUrl  String?
  
  // Medical Info
  allergies String?
  notes     String?
  
  tutorId   String
  tutor     Tutor    @relation(fields: [tutorId], references: [id])
  
  consultations Consultation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// RENAMED: MedicalRecord -> Consultation
// This is now the core entity.
model Consultation {
  id        String   @id @default(cuid())
  date      DateTime @default(now())
  title     String   // e.g., "Routine Checkup" or "Emergency"

  // AI & Audio Data
  audioUrl       String?
  soapTranscript Json?    // Structured SOAP (Subjective, Objective, Assessment, Plan)
  summary        String?  // AI Summary

  // Standard Clinical Data (Backward compatibility/Structured)
  anamnesis    String?
  physicalExam String?
  diagnosis    String?
  prescription String?
  vitalSigns   Json?    // { temp: 38, heartRate: 100, respiratoryRate: 20, weight: 10, capillaryFill: 2, hydration: "Normal" }
  
  petId     String
  pet       Pet      @relation(fields: [petId], references: [id])
  
  vetId     String
  vet       User     @relation(fields: [vetId], references: [id])
  
  documents Document[] @relation("ConsultationDocs")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// NEW: Document Storage (PDFs with Hash)
model Document {
  id        String   @id @default(cuid())
  name      String
  url       String
  type      String   // PRESCRIPTION, CONSENT, EXAM_RESULT
  hash      String?  // For validation/integrity
  
  consultationId String?
  consultation   Consultation? @relation("ConsultationDocs", fields: [consultationId], references: [id])

  createdAt DateTime @default(now())
}

// NEW: Clinical Chat (Vet <-> Tutor)
model ChatSession {
  id        String   @id @default(cuid())
  status    String   @default("OPEN") // OPEN, ARCHIVED
  
  vetId     String
  vet       User     @relation("VetChats", fields: [vetId], references: [id])
  
  tutorId   String
  tutor     Tutor    @relation(fields: [tutorId], references: [id])
  
  messages  ChatMessage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ChatMessage {
  id        String   @id @default(cuid())
  content   String
  read      Boolean  @default(false)
  
  senderId  String
  sender    User     @relation("SentMessages", fields: [senderId], references: [id])
  
  sessionId String
  session   ChatSession @relation(fields: [sessionId], references: [id])

  createdAt DateTime @default(now())
}

// NEW: Clinical Tools (Mobile First)
model Drug {
  id          String   @id @default(cuid())
  name        String   // e.g., "Amoxicilina"
  description String?
  category    String?  // Antibiótico, Analgésico
  mechanism   String?
  
  // Dosage Info
  defaultDoseMgKg Float? // Standard dose
  presentation    String? // e.g. "Comprimidos 500mg"
  
  contraindications String[]
  interactions      String[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CalculationLog {
  id        String   @id @default(cuid())
  type      String   // DOSE, FLUID, CRIT_CARE
  input     Json     // { weight: 10, dose: 25 ... }
  result    String
  
  date      DateTime @default(now())
  
  vetId     String
  vet       User     @relation(fields: [vetId], references: [id])
}
