# VetOS Production Docker Compose for Coolify
# Uses external db-proxy running on host network for IPv6 Supabase access

services:
  # Main Application
  app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_SUPABASE_URL: '${NEXT_PUBLIC_SUPABASE_URL}'
        NEXT_PUBLIC_SUPABASE_ANON_KEY: '${NEXT_PUBLIC_SUPABASE_ANON_KEY}'
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      NODE_ENV: production
      # Supabase Session Mode Pooler (IPv4 compatible per docs)
      # Format: postgres://postgres.[PROJECT_REF]:[PASSWORD]@aws-0-[REGION].pooler.supabase.com:5432/postgres
      DATABASE_URL: 'postgresql://postgres.rhxticpmcdzbmnfblkuk:RsnjJzER79WF8mAe@aws-0-us-east-1.pooler.supabase.com:5432/postgres'
      AUTH_SECRET: '${AUTH_SECRET}'
      AUTH_TRUST_HOST: 'true'
      NEXTAUTH_URL: '${NEXTAUTH_URL}'
      NEXT_PUBLIC_SUPABASE_URL: '${NEXT_PUBLIC_SUPABASE_URL}'
      NEXT_PUBLIC_SUPABASE_ANON_KEY: '${NEXT_PUBLIC_SUPABASE_ANON_KEY}'
      SUPABASE_SERVICE_ROLE_KEY: '${SUPABASE_SERVICE_ROLE_KEY}'
      OPENAI_API_KEY: '${OPENAI_API_KEY}'
    healthcheck:
      test:
        - CMD
        - wget
        - '--no-verbose'
        - '--tries=1'
        - '--spider'
        - 'http://127.0.0.1:3000/api/auth/session'
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
