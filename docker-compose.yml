# VetOS Production Docker Compose for Coolify
# Includes db-proxy to handle IPv6-only Supabase connection

services:
  # IPv6 Proxy - forwards IPv4 to Supabase IPv6 endpoint
  db-proxy:
    image: alpine/socat:latest
    container_name: db-proxy
    command: TCP4-LISTEN:5432,fork,reuseaddr TCP6:db.rhxticpmcdzbmnfblkuk.supabase.co:5432
    restart: unless-stopped
    networks:
      - default

  # Main Application
  app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_SUPABASE_URL: '${NEXT_PUBLIC_SUPABASE_URL}'
        NEXT_PUBLIC_SUPABASE_ANON_KEY: '${NEXT_PUBLIC_SUPABASE_ANON_KEY}'
    environment:
      NODE_ENV: production
      # Connect to db-proxy instead of direct Supabase URL
      DATABASE_URL: 'postgresql://postgres:RsnjJzER79WF8mAe@db-proxy:5432/postgres'
      AUTH_SECRET: '${AUTH_SECRET}'
      AUTH_TRUST_HOST: 'true'
      NEXTAUTH_URL: '${NEXTAUTH_URL}'
      NEXT_PUBLIC_SUPABASE_URL: '${NEXT_PUBLIC_SUPABASE_URL}'
      NEXT_PUBLIC_SUPABASE_ANON_KEY: '${NEXT_PUBLIC_SUPABASE_ANON_KEY}'
      SUPABASE_SERVICE_ROLE_KEY: '${SUPABASE_SERVICE_ROLE_KEY}'
      OPENAI_API_KEY: '${OPENAI_API_KEY}'
    depends_on:
      - db-proxy
    healthcheck:
      test:
        - CMD
        - wget
        - '--no-verbose'
        - '--tries=1'
        - '--spider'
        - 'http://127.0.0.1:3000/api/auth/session'
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped

networks:
  default:
    name: coolify
    external: true
