# VetOS Production Docker Compose for Coolify
# Uses external db-proxy running on host network for IPv6 Supabase access

services:
  # Main Application
  app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_SUPABASE_URL: 'https://rhxticpmcdzbmnfblkuk.supabase.co'
        NEXT_PUBLIC_SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJoeHRpY3BtY2R6Ym1uZmJsa3VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4NDUzNDUsImV4cCI6MjA4MTQyMTM0NX0.kqTyaBsp-6A3jLWHTjI3n03TC-okKctkhw-3xTlNdSE'
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      NODE_ENV: production
      # Supabase Session Mode Pooler (IPv4 compatible per docs)
      # Format: postgres://postgres.[PROJECT_REF]:[PASSWORD]@aws-0-[REGION].pooler.supabase.com:5432/postgres
      DATABASE_URL: '${DATABASE_URL}'
      AUTH_SECRET: '${AUTH_SECRET}'
      AUTH_TRUST_HOST: 'true'
      NEXTAUTH_URL: '${NEXTAUTH_URL}'
      NEXT_PUBLIC_SUPABASE_URL: '${NEXT_PUBLIC_SUPABASE_URL}'
      NEXT_PUBLIC_SUPABASE_ANON_KEY: '${NEXT_PUBLIC_SUPABASE_ANON_KEY}'
      SUPABASE_SERVICE_ROLE_KEY: '${SUPABASE_SERVICE_ROLE_KEY}'
      OPENAI_API_KEY: '${OPENAI_API_KEY}'
    healthcheck:
      test:
        - CMD
        - wget
        - '--no-verbose'
        - '--tries=1'
        - '--spider'
        - 'http://127.0.0.1:3000/api/auth/session'
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
