<img src="https://r2cdn.perplexity.ai/pplx-full-logo-primary-dark%402x.png" style="height:64px;margin-right:32px"/>

# ğŸ—ï¸ ARCHITECTURE DOCUMENT v1.0 - FRED Veterinary AI Platform

**Architect:** Alex (BMAD)
**Data:** 06 de Dezembro de 2025
**Status:** ğŸ“„ COMPLETO
**Projeto:** Sistema All-in-One VeterinÃ¡rio com IA
**Stack:** Next.js 14 + TypeScript + PostgreSQL + MinIO + Coolify

***

## Document Control

| Item | Detalhes |
| :-- | :-- |
| VersÃ£o | 1.0 FINAL |
| Data CriaÃ§Ã£o | 06/12/2025 |
| Arch DecisÃµes | 12 ADRs (detalhados) |
| Diagrama Principal | System Context + Component + Deployment |
| Tecnologias | 22 ferramentas + integraÃ§Ãµes |
| SeguranÃ§a | LGPD + HTTPS + encryption |
| Performance Target | >85 mobile Lighthouse |


***

## 1. System Architecture Overview

### 1.1 High-Level Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        CLIENT LAYER                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚   Web Browser        â”‚  â”‚   Mobile Browser     â”‚              â”‚
â”‚  â”‚  (Next.js Client)    â”‚  â”‚  (Responsive UI)     â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚           â”‚                           â”‚                           â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                           â”‚ HTTPS/TLS 1.2+                       â”‚
â”‚                           â”‚                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     API GATEWAY LAYER                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Nginx Reverse Proxy (Coolify)                          â”‚    â”‚
â”‚  â”‚  - Rate Limiting (100 req/min brute-force)              â”‚    â”‚
â”‚  â”‚  - CORS handling                                        â”‚    â”‚
â”‚  â”‚  - SSL/TLS termination                                  â”‚    â”‚
â”‚  â”‚  - Gzip compression                                     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                           â”‚                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    APPLICATION LAYER                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Next.js 14 (App Router + API Routes)                   â”‚    â”‚
â”‚  â”‚  â”œâ”€ /app/         (UI pages, components, layouts)       â”‚    â”‚
â”‚  â”‚  â””â”€ /api/         (Backend routes + micrologic)         â”‚    â”‚
â”‚  â”‚                                                          â”‚    â”‚
â”‚  â”‚  Middleware:                                            â”‚    â”‚
â”‚  â”‚  - NextAuth.js (auth + session management)              â”‚    â”‚
â”‚  â”‚  - RBAC (role-based access control)                     â”‚    â”‚
â”‚  â”‚  - Error handling (centralized)                         â”‚    â”‚
â”‚  â”‚  - Request validation (Zod schemas)                     â”‚    â”‚
â”‚  â”‚  - Logging (Winston/Pino)                               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                           â”‚                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Service Layer (Business Logic)                         â”‚    â”‚
â”‚  â”‚  â”œâ”€ ConsultationService                                 â”‚    â”‚
â”‚  â”‚  â”œâ”€ MedicalRecordService                                â”‚    â”‚
â”‚  â”‚  â”œâ”€ TranscriptionService                                â”‚    â”‚
â”‚  â”‚  â”œâ”€ FredarService (chat + monitoring)                   â”‚    â”‚
â”‚  â”‚  â”œâ”€ CompetitorService (farejador)                       â”‚    â”‚
â”‚  â”‚  â””â”€ BillingService                                      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚              â”‚              â”‚              â”‚
     â–¼              â–¼              â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DATA & STORAGE LAYER                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ PostgreSQL   â”‚  â”‚   MinIO      â”‚  â”‚   Redis      â”‚          â”‚
â”‚  â”‚ (Relational) â”‚  â”‚  (S3 Storage)â”‚  â”‚  (Cache)     â”‚          â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚          â”‚
â”‚  â”‚ Prisma ORM   â”‚  â”‚ Audio files  â”‚  â”‚ Sessions     â”‚          â”‚
â”‚  â”‚ (Query opt)  â”‚  â”‚ PDFs         â”‚  â”‚ Tokens       â”‚          â”‚
â”‚  â”‚              â”‚  â”‚ Images       â”‚  â”‚ Cache data   â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                   â”‚
â”‚  Backup Layer:                                                   â”‚
â”‚  â””â”€ Backblaze B2 (PostgreSQL daily dump + MinIO snapshots)      â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚              â”‚              â”‚
     â–¼              â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  EXTERNAL INTEGRATIONS                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ OpenAI API   â”‚  â”‚ Google API   â”‚  â”‚ Stripe/      â”‚          â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚ Pagar.me     â”‚          â”‚
â”‚  â”‚ - Whisper    â”‚  â”‚ - Gemini 2.5 â”‚  â”‚              â”‚          â”‚
â”‚  â”‚ - GPT-4o     â”‚  â”‚ - Grounding  â”‚  â”‚ Payment      â”‚          â”‚
â”‚  â”‚              â”‚  â”‚   Search     â”‚  â”‚ processing   â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚  â”‚ Mailgun/     â”‚  â”‚ Sentry/      â”‚                            â”‚
â”‚  â”‚ Sendgrid     â”‚  â”‚ UptimeRobot  â”‚                            â”‚
â”‚  â”‚              â”‚  â”‚              â”‚                            â”‚
â”‚  â”‚ Email        â”‚  â”‚ Monitoring   â”‚                            â”‚
â”‚  â”‚ transacional â”‚  â”‚ & Alerting   â”‚                            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


### 1.2 Component Diagram (Detalhe Interno)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     NEXT.JS APPLICATION                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ UI Layer (/app)                                                 â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  â”œâ”€ (dashboard)         [Veterinarian/Admin/Attendant views]   â”‚  â”‚
â”‚  â”‚  â”œâ”€ (schedule)          [Agenda - dia/semana/mÃªs]              â”‚  â”‚
â”‚  â”‚  â”œâ”€ (patients)          [Tutores/Pets CRUD]                    â”‚  â”‚
â”‚  â”‚  â”œâ”€ (consultations)     [Criar/editar/cancelar]                â”‚  â”‚
â”‚  â”‚  â”œâ”€ (records)           [HistÃ³rico prontuÃ¡rios]                â”‚  â”‚
â”‚  â”‚  â”œâ”€ (prescriptions)     [GeraÃ§Ã£o receitas]                     â”‚  â”‚
â”‚  â”‚  â”œâ”€ (fredar)            [Chat FRED + Farejador]                â”‚  â”‚
â”‚  â”‚  â”œâ”€ (tutor-portal)      [Portal para clientes]                 â”‚  â”‚
â”‚  â”‚  â”œâ”€ (settings)          [ConfiguraÃ§Ãµes clÃ­nica/user]           â”‚  â”‚
â”‚  â”‚  â”œâ”€ (auth)              [Login/signup/reset]                   â”‚  â”‚
â”‚  â”‚  â””â”€ (onboarding)        [Setup inicial Farejador]              â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  Shared Components:                                             â”‚  â”‚
â”‚  â”‚  â”œâ”€ /components/ui      [Buttons, cards, forms, etc]           â”‚  â”‚
â”‚  â”‚  â”œâ”€ /components/fred    [Chat, notifications, mini-ficha]      â”‚  â”‚
â”‚  â”‚  â”œâ”€ /components/charts  [GrÃ¡ficos concorrentes]                â”‚  â”‚
â”‚  â”‚  â””â”€ /hooks              [useAuth, useFredar, useConsultation]  â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                            â”‚                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ API Layer (/api)                                                â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  â”œâ”€ /api/auth/           [NextAuth.js routes]                  â”‚  â”‚
â”‚  â”‚  â”œâ”€ /api/consultations/  [CRUD + cancel + cancel reason]       â”‚  â”‚
â”‚  â”‚  â”œâ”€ /api/patients/       [Tutor + Pet CRUD]                    â”‚  â”‚
â”‚  â”‚  â”œâ”€ /api/records/        [Medical record CRUD]                 â”‚  â”‚
â”‚  â”‚  â”œâ”€ /api/transcription/  [Upload + Whisper call]               â”‚  â”‚
â”‚  â”‚  â”œâ”€ /api/prescriptions/  [Generate + template]                 â”‚  â”‚
â”‚  â”‚  â”œâ”€ /api/fredar/         [Chat + search + reminders]           â”‚  â”‚
â”‚  â”‚  â”œâ”€ /api/competitors/    [Monitor + list + add]                â”‚  â”‚
â”‚  â”‚  â”œâ”€ /api/billing/        [Stripe webhook + subscription]       â”‚  â”‚
â”‚  â”‚  â””â”€ /api/webhooks/       [Stripe, email delivery, etc]         â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  Middleware (Next.js):                                          â”‚  â”‚
â”‚  â”‚  â”œâ”€ middleware.ts        [Auth check, CORS, logging]           â”‚  â”‚
â”‚  â”‚  â””â”€ error.ts             [Global error handling]               â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                            â”‚                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Services Layer (lib/)                                           â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  â”œâ”€ prisma.ts            [Prisma client singleton]              â”‚  â”‚
â”‚  â”‚  â”œâ”€ auth.ts              [NextAuth config]                      â”‚  â”‚
â”‚  â”‚  â”œâ”€ consultationService  [Business logic]                       â”‚  â”‚
â”‚  â”‚  â”œâ”€ transcriptionService [Whisper call + retries]              â”‚  â”‚
â”‚  â”‚  â”œâ”€ medicalRecordService [GPT-4o call + validation]            â”‚  â”‚
â”‚  â”‚  â”œâ”€ fredarService        [Gemini integration + search]          â”‚  â”‚
â”‚  â”‚  â”œâ”€ competitorService    [Gemini Grounding + crawl]            â”‚  â”‚
â”‚  â”‚  â”œâ”€ storageService       [MinIO S3 operations]                  â”‚  â”‚
â”‚  â”‚  â”œâ”€ notificationService  [Email/SMS/chat notifications]         â”‚  â”‚
â”‚  â”‚  â”œâ”€ billingService       [Stripe API calls]                     â”‚  â”‚
â”‚  â”‚  â””â”€ validationService    [Zod schemas + business rules]         â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                            â”‚                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Cron Jobs / Background Tasks                                   â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  â”œâ”€ /jobs/fredar-journal.ts    [06:00 AM daily]               â”‚  â”‚
â”‚  â”‚  â”œâ”€ /jobs/reminders.ts          [Every 30 min during work]    â”‚  â”‚
â”‚  â”‚  â”œâ”€ /jobs/backup.ts             [02:00 AM daily]              â”‚  â”‚
â”‚  â”‚  â””â”€ /jobs/cleanup.ts            [03:00 AM daily]              â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  Run via: Coolify scheduler / GitHub Actions / node-cron       â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


### 1.3 Data Flow Diagram (Audio â†’ ProntuÃ¡rio)

```
VETERINARIAN FLOW: Audio Upload â†’ ProntuÃ¡rio
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. VET UPLOADS AUDIO
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Vet clica "Gravar/Upload" em consulta                  â”‚
   â”‚ - Seleciona arquivo .mp3/.wav/.m4a/.ogg/.webm (50MB)   â”‚
   â”‚ - Drag-drop ou file picker                              â”‚
   â”‚ - ValidaÃ§Ã£o file size + format (client-side)            â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
2. UPLOAD TO MINIO
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ POST /api/transcription/upload                          â”‚
   â”‚ - FormData: file + consultationId                       â”‚
   â”‚ - Server validaÃ§Ã£o size/format                          â”‚
   â”‚ - Progress bar (streaming upload)                       â”‚
   â”‚ - Armazena: MinIO/audios/{clinic}/{consultation}.mp3   â”‚
   â”‚ - Resposta: { audioId, status: 'processing' }          â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
3. TRIGGER WHISPER TRANSCRIPTION
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ POST /api/transcription/generate (async)                â”‚
   â”‚ - Server: LÃª arquivo MinIO                              â”‚
   â”‚ - Calls: OpenAI Whisper API (model: large)              â”‚
   â”‚ - Whisper timeout: 300 segundos (max 60min audio)       â”‚
   â”‚ - Output: { text: "...", language: "pt" }              â”‚
   â”‚ - Salva transcription em DB (Consultation.transcription)â”‚
   â”‚ - Notifica VET via browser + email ("Pronto!")         â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
4. GENERATE MEDICAL RECORD (GPT-4o)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ POST /api/records/generate-from-transcript              â”‚
   â”‚ - Inputs:                                               â”‚
   â”‚   - Transcription text                                  â”‚
   â”‚   - Pet context (nome, age, weight, allergies)         â”‚
   â”‚   - Previous records (Ãºltimas 3 consultas)             â”‚
   â”‚                                                         â”‚
   â”‚ - Crafted Prompt:                                       â”‚
   â”‚   "Extract these from veterinary consultation:         â”‚
   â”‚    - Chief complaint, symptoms, physical exam findings  â”‚
   â”‚    - Preliminary diagnosis, differentials              â”‚
   â”‚    - Tests ordered, medications prescribed             â”‚
   â”‚    - Client instructions, follow-up date               â”‚
   â”‚    Return as JSON: {...}"                              â”‚
   â”‚                                                         â”‚
   â”‚ - Calls: OpenAI GPT-4o API                              â”‚
   â”‚ - GPT timeout: 60 segundos                              â”‚
   â”‚ - Output: JSON estruturado                              â”‚
   â”‚ - Salva em cache Redis por 1 hora (retry safety)       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
5. VET REVIEWS & CONFIRMS
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ GET /records/review (prÃ©-preenchido com IA data)        â”‚
   â”‚ - FormulÃ¡rio: Cada campo com checkbox                   â”‚
   â”‚   â˜‘ï¸ Correto  |  âŒ Editar  |  âœ• Remover              â”‚
   â”‚                                                         â”‚
   â”‚ - Vet revisa, faz ajustes (editing inline)              â”‚
   â”‚ - Diagnosis obrigatÃ³rio (validaÃ§Ã£o)                     â”‚
   â”‚ - MÃ­nimo 1 campo preenchido                             â”‚
   â”‚ - Signature: Data + Nome + CRM auto-filled              â”‚
   â”‚ - BotÃµes: "Salvar", "Descartar", "Salvar+Receita"      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
6. SAVE MEDICAL RECORD
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ POST /api/records/save                                  â”‚
   â”‚ - ValidaÃ§Ã£o final (Zod schema)                          â”‚
   â”‚ - Cria MedicalRecord entry (relacionado Consultation)   â”‚
   â”‚ - Gera PDF (PrintJS ou react-pdf library)              â”‚
   â”‚ - Armazena: MinIO/records/{clinic}/{record}.pdf        â”‚
   â”‚ - Salva em DB: record.pdfPath                           â”‚
   â”‚ - Timestamp: signedAt = now()                           â”‚
   â”‚ - Permanente (nÃ£o pode apagar, soft-delete apenas)      â”‚
   â”‚                                                         â”‚
   â”‚ - Notifica:                                             â”‚
   â”‚   - Tutor: Email "ProntuÃ¡rio disponÃ­vel"               â”‚
   â”‚   - Admin: Log auditoria (quem, quando, dados)         â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
7. OPTIONAL: GENERATE PRESCRIPTION
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ POST /api/prescriptions/generate                        â”‚
   â”‚ - Pre-preenche medications do MedicalRecord             â”‚
   â”‚ - Vet seleciona template: Simple/Controlled/Special     â”‚
   â”‚ - Vet revisa + assina                                   â”‚
   â”‚ - Salva Prescription entry + PDF                        â”‚
   â”‚ - Tutor recebe via email                                â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

TIMELINE: Audio upload â†’ ProntuÃ¡rio pronto ~5-7 minutes
   1. Upload: 30-60s (file size dependente)
   2. Whisper: 2-3 min (60min audio)
   3. GPT-4o: 30-60s
   4. Vet review: Manual (5-10 min)
   5. Save: <1s
```


### 1.4 Data Flow Diagram (FRED Chat - Natural Search)

```
FRED CHAT: "Qual foi o Ãºltimo exame do Rex?"
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. USER SENDS MESSAGE
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ User: "Qual foi o Ãºltimo exame do Rex?"                â”‚
   â”‚ - Chat input (textarea) â†’ sends to server               â”‚
   â”‚ - Context: clinicId, userId (via JWT)                  â”‚
   â”‚ - Message logged para auditoria                         â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
2. GROUNDING (DB SEARCH FIRST)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ FredarService.processMessage()                          â”‚
   â”‚ - Parse user input: Extract keywords "exam" + "Rex"    â”‚
   â”‚ - Query DB:                                             â”‚
   â”‚   SELECT * FROM pets WHERE name ILIKE '%Rex%'          â”‚
   â”‚   AND clinicId = $1                                    â”‚
   â”‚                                                         â”‚
   â”‚ - If found: Fetch last exam                             â”‚
   â”‚   SELECT * FROM medical_records mr                     â”‚
   â”‚   INNER JOIN consultations c ON mr.consultationId = c.id
   â”‚   WHERE c.petId = $petId                               â”‚
   â”‚   AND mr.examination IS NOT NULL                        â”‚
   â”‚   ORDER BY c.scheduledDate DESC LIMIT 1                â”‚
   â”‚                                                         â”‚
   â”‚ - If NOT found: Ask "Desculpe, nÃ£o encontrei pet 'Rex'"â”‚
   â”‚   Quer que eu... [agende novo?]"                       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
3. CONTEXT BUILDING
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ If found:                                               â”‚
   â”‚ context = {                                             â”‚
   â”‚   petId: "...",                                         â”‚
   â”‚   petName: "Rex",                                       â”‚
   â”‚   age: "5 years",                                       â”‚
   â”‚   lastExam: {                                           â”‚
   â”‚     date: "2025-11-15",                                â”‚
   â”‚     vet: "Dra. Maria",                                  â”‚
   â”‚     findings: "Exame fÃ­sico normal...",                â”‚
   â”‚     tests: "Hemograma: WBC normal"                      â”‚
   â”‚   }                                                     â”‚
   â”‚ }                                                       â”‚
   â”‚                                                         â”‚
   â”‚ Build prompt for Gemini:                                â”‚
   â”‚ "User asked: 'Qual foi o Ãºltimo exame do Rex?'        â”‚
   â”‚  Pet: Rex, 5 years old                                 â”‚
   â”‚  Last exam: 2025-11-15, Dra. Maria                     â”‚
   â”‚  Findings: [...]                                       â”‚
   â”‚  Please respond naturally in Portuguese about this      â”‚
   â”‚  exam. Keep response concise (2-3 sentences)."         â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
4. CALL GEMINI (NO HALLUCINATION)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ POST https://generativelanguage.googleapis.com/v1beta...â”‚
   â”‚ - Model: gemini-2.5-flash                              â”‚
   â”‚ - System prompt: "You're FRED, veterinary assistant"   â”‚
   â”‚ - Messages: [                                           â”‚
   â”‚     { role: "user", content: "..." },                   â”‚
   â”‚     { role: "model", content: "..." },  // history      â”‚
   â”‚     { role: "user", content: prompt }   // current      â”‚
   â”‚   ]                                                     â”‚
   â”‚ - Temperature: 0.3 (mais focado, menos criativo)        â”‚
   â”‚ - Max tokens: 200 (respostas curtas)                    â”‚
   â”‚ - Timeout: 10s                                          â”‚
   â”‚ - Response: "O Ãºltimo exame do Rex foi em 15/11...     â”‚
   â”‚             encontrou-se tudo normal..."                â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
5. SEND QUICK ACTION BUTTONS
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Response formatado:                                     â”‚
   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
   â”‚ â”‚ FRED:                                 â”‚             â”‚
   â”‚ â”‚ "O Ãºltimo exame do Rex foi em 15/11..â”‚             â”‚
   â”‚ â”‚  encontrou-se tudo normal..."         â”‚             â”‚
   â”‚ â”‚                                        â”‚             â”‚
   â”‚ â”‚ [ğŸ” Ver completo] [ğŸ“‹ Hist. completo]â”‚            â”‚
   â”‚ â”‚ [ğŸ“… Agendar consulta] [ğŸ’Š Editar]    â”‚            â”‚
   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
   â”‚                                                        â”‚
   â”‚ - BotÃµes executam aÃ§Ãµes (abre modal, navega, etc)     â”‚
   â”‚ - Context mantido (pode fazer follow-up questions)    â”‚
   â”‚ - HistÃ³rico limitado a 10 mensagens (Ã©vita token bloat)
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
6. LOG & AUDIT
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Salva em FredarLog:                                     â”‚
   â”‚ {                                                       â”‚
   â”‚   clinicId, userId, type: "chat_message",              â”‚
   â”‚   query: "Qual foi o Ãºltimo exame do Rex?",            â”‚
   â”‚   response: "O Ãºltimo exame...",                       â”‚
   â”‚   metadata: {                                           â”‚
   â”‚     petsSearched: ["Rex"],                             â”‚
   â”‚     recordsFound: 1,                                   â”‚
   â”‚     llmModel: "gemini-2.5-flash",                      â”‚
   â”‚     latency: "1250ms"                                  â”‚
   â”‚   }                                                    â”‚
   â”‚ }                                                       â”‚
   â”‚                                                        â”‚
   â”‚ Useful for: Auditing, improving prompts, analyzing usage
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

KEY SAFETY: Grounding (DB search first) prevents FRED from
making up patients or fabricating medical info. If not in DB,
FRED says so explicitly and suggests actions.

LATENCY TARGET: <2s end-to-end (including Gemini call)
```


### 1.5 Farejador Daily Journal Flow

```
FAREJADOR: Jornal do Fred - Daily Intelligence Report
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CRON JOB RUNS: Daily 06:00 AM (clinic timezone)
   â”œâ”€ Node cron or GitHub Actions
   â””â”€ Triggered via Coolify scheduler

1. FETCH YOUR CLINIC DATA
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ CompetitorService.getYourClinic(clinicId)               â”‚
   â”‚ - Query Google Maps: Your clinic name + location        â”‚
   â”‚ - Extract: Current rating, review count, last reviews   â”‚
   â”‚ - Extract: Recent posts (if Instagram/Facebook)         â”‚
   â”‚ - Compare with yesterday's snapshot                     â”‚
   â”‚ - Changes: Delta in rating, new reviews, new posts      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
2. FETCH COMPETITORS DATA
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ CompetitorService.updateCompetitors(clinicId)           â”‚
   â”‚ - Loop over monitored competitors (max 20)              â”‚
   â”‚ - For each:                                             â”‚
   â”‚   â”œâ”€ Google Maps: Rating + review count + recent reviewsâ”‚
   â”‚   â”œâ”€ Instagram: Latest posts (if handle known)          â”‚
   â”‚   â”‚  - Extract: Likes, comments, engagement              â”‚
   â”‚   â”‚  - Post date, caption length                         â”‚
   â”‚   â”œâ”€ Facebook: Page likes, recent posts                 â”‚
   â”‚   â”œâ”€ Website: Check if updated (optional, future)       â”‚
   â”‚   â””â”€ Store deltas in DB (dailyTracking table future)    â”‚
   â”‚                                                         â”‚
   â”‚ - Use: Gemini Grounding Search (public web scraping)    â”‚
   â”‚ - Respect: robots.txt, rate limits                      â”‚
   â”‚ - Timeout: 60s per competitor (safety)                  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
3. ANALYZE TRENDS & OPPORTUNITIES
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ AnalyticsService.generateInsights()                     â”‚
   â”‚                                                         â”‚
   â”‚ Calculate:                                              â”‚
   â”‚ - Your rating vs competitors average                    â”‚
   â”‚ - Your review growth rate                               â”‚
   â”‚ - New competitors entered market (5km radius)           â”‚
   â”‚ - Competitors with rating decrease (opportunity?)       â”‚
   â”‚ - Top performers by rating (what they do?)              â”‚
   â”‚ - Your weaknesses vs market leader                      â”‚
   â”‚                                                         â”‚
   â”‚ Suggestions:                                            â”‚
   â”‚ - "Seu concorrente X teve -0.5 rating queda.            â”‚
   â”‚   Considere campanha de avaliaÃ§Ãµes positivas"           â”‚
   â”‚ - "Nenhum concorrente oferece [serviÃ§o X].              â”‚
   â”‚   Oportunidade de diferenciaÃ§Ã£o"                        â”‚
   â”‚ - "VocÃª estÃ¡ [X] reviews abaixo da mÃ©dia local.         â”‚
   â”‚   Meta: Solicitar 5 reviews este mÃªs"                  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
4. BUILD JOURNAL CONTENT
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Journal structure (4 sections):                          â”‚
   â”‚                                                         â”‚
   â”‚ â”Œâ”€ Section 1: SEU NEGÃ“CIO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
   â”‚ â”‚ "VocÃª estÃ¡ em [bairro], com nota [4.8]        â”‚       â”‚
   â”‚ â”‚  Ãšltimas 7 dias:                               â”‚       â”‚
   â”‚ â”‚  + 12 novas consultas agendadas                â”‚       â”‚
   â”‚ â”‚  + 15 pacientes completaram                    â”‚       â”‚
   â”‚ â”‚  + 2 novos reviews 5â­"                        â”‚       â”‚
   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
   â”‚                                                         â”‚
   â”‚ â”Œâ”€ Section 2: MERCADO LOCAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
   â”‚ â”‚ "MudanÃ§as Ãºltimas 24h:                         â”‚       â”‚
   â”‚ â”‚ â€¢ 1 nova clÃ­nica abriu a 3km                   â”‚       â”‚
   â”‚ â”‚ â€¢ ClÃ­nica X: Rating â†‘ de 4.5 â†’ 4.7            â”‚       â”‚
   â”‚ â”‚ â€¢ ClÃ­nica Y: 3 novos reviews (mÃ©dia 4â­)       â”‚       â”‚
   â”‚ â”‚ â€¢ Nenhuma atividade em telemedicina local"     â”‚       â”‚
   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
   â”‚                                                         â”‚
   â”‚ â”Œâ”€ Section 3: TOP 3 CONCORRENTES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
   â”‚ â”‚ "ClÃ­nica A (4.9â­, 120 reviews):               â”‚       â”‚
   â”‚ â”‚   - Ãšltimo post Instagram: 2 dias, 45 likes   â”‚       â”‚
   â”‚ â”‚   - Website: Agora oferece telemedicina       â”‚       â”‚
   â”‚ â”‚   - TendÃªncia: â†‘ (favorÃ¡vel)                  â”‚       â”‚
   â”‚ â”‚                                                â”‚       â”‚
   â”‚ â”‚ ClÃ­nica B (4.3â­, 80 reviews):                â”‚       â”‚
   â”‚ â”‚   - Ãšltimo post: 5 dias atrÃ¡s                 â”‚       â”‚
   â”‚ â”‚   - Review recente: 'â­ Service lento'        â”‚       â”‚
   â”‚ â”‚   - TendÃªncia: â†“ (oportunidade!)"             â”‚       â”‚
   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
   â”‚                                                         â”‚
   â”‚ â”Œâ”€ Section 4: AÃ‡Ã•ES RECOMENDADAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
   â”‚ â”‚ "PrÃ³ximas 48h:                                 â”‚       â”‚
   â”‚ â”‚ âœ“ ClÃ­nica B com reviews negativos.             â”‚       â”‚
   â”‚ â”‚   â†’ Foque em atendimento excelente             â”‚       â”‚
   â”‚ â”‚   â†’ Solicitar reviews ao final consulta        â”‚       â”‚
   â”‚ â”‚                                                â”‚       â”‚
   â”‚ â”‚ âœ“ ClÃ­nica A iniciou telemedicina.              â”‚       â”‚
   â”‚ â”‚   â†’ Pesquise regulamentaÃ§Ã£o CFMV               â”‚       â”‚
   â”‚ â”‚   â†’ Considere oferecer tambÃ©m                  â”‚       â”‚
   â”‚ â”‚                                                â”‚       â”‚
   â”‚ â”‚ âœ“ Sua nota: 0.1 pontos abaixo mÃ©dia.           â”‚       â”‚
   â”‚ â”‚   â†’ Meta: +3 reviews 5â­ esta semana"          â”‚       â”‚
   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
5. SAVE TO DATABASE & EMAIL
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ FredarJournal.create({                                  â”‚
   â”‚   clinicId,                                             â”‚
   â”‚   journalDate: today,                                   â”‚
   â”‚   clinicSection: JSON.stringify({ rating, changes }),  â”‚
   â”‚   localSection: JSON.stringify({ market_data }),        â”‚
   â”‚   competitorSection: JSON.stringify({ competitors }),   â”‚
   â”‚   opportunitiesSection: JSON.stringify({ actions })     â”‚
   â”‚ })                                                       â”‚
   â”‚                                                         â”‚
   â”‚ NotificationService.sendEmail({                         â”‚
   â”‚   to: admin@clinic.com,                                 â”‚
   â”‚   template: "fredar-journal",                           â”‚
   â”‚   data: { journal, clinic_name }                        â”‚
   â”‚ })                                                       â”‚
   â”‚                                                         â”‚
   â”‚ Response: Email enviado em <5s                          â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
6. DISPLAY IN DASHBOARD
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ GET /api/fredar/journal/latest                          â”‚
   â”‚ - Retorna: Ãšltima journal entry (today's date)          â”‚
   â”‚ - Cache: 1 hour (nÃ£o refetch constantemente)            â”‚
   â”‚ - UI: Cards expandÃ­veis por seÃ§Ã£o                       â”‚
   â”‚ - GrÃ¡fico: Rating histÃ³rico (30 dias)                   â”‚
   â”‚ - BotÃµes: "Compartilhar", "Exportar PDF", "Ver histÃ³rico"
   â”‚                                                         â”‚
   â”‚ GET /api/fredar/journal/history?days=30                 â”‚
   â”‚ - Retorna: Ãšltimas 30 entradas                          â”‚
   â”‚ - Timeline view (clicÃ¡vel por data)                     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

KEY CHARACTERISTICS:
- DiÃ¡rio: Sempre mesma hora (06:00), nÃ£o real-time
- Privado: SÃ³ admin acessa (dados sensÃ­veis)
- Insightful: NÃ£o apenas dados, traz sugestÃµes aÃ§Ã£o
- Gratuito: IncluÃ­do no plano (nÃ£o consume quota IA muito)
- EscalÃ¡vel: Mesmo job roda para 1-1000 clÃ­nicas
```


***

## 2. Technology Stack Deep Dive

### 2.1 Frontend Stack

| Tecnologia | VersÃ£o | FunÃ§Ã£o | Justificativa |
| :-- | :-- | :-- | :-- |
| **Next.js** | 14+ (App Router) | Framework React | SSR/SSG, built-in API routes, performance optimized |
| **TypeScript** | 5.0+ | Type safety | Previne bugs em produÃ§Ã£o, melhor IDE experience |
| **React** | 18+ | UI library | Modern hooks, concurrent features, estÃ¡vel |
| **Tailwind CSS** | 3.3+ | Styling | Utility-first, rÃ¡pido desenvolvimento, design system |
| **Shadcn/ui** | Latest | Component library | Accessible, customizable, Tailwind-based |
| **React Hook Form** | 7.x | Form management | Lightweight, performance-optimized |
| **Zod** | 3.x | Schema validation | TypeScript-native, runtime validation |
| **Zustand** | 4.x | State management | Lightweight (2KB), nÃ£o precisa Context hell |
| **TanStack Query** | v5 | Server state | Caching, background sync, real-time updates |
| **Framer Motion** | 10.x | Animations | Smooth, performant animations (FRED chat) |
| **Recharts** | 2.x | Charts | React components, responsive, competidor grÃ¡ficos |
| **date-fns** | 2.x | Date utilities | Tree-shakeable, smaller than moment.js |
| **clsx** | 2.x | Class utilities | Conditional classNames |

**Architecture:**

- Pages: `/app/(auth)`, `/app/(dashboard)`, `/app/(tutor-portal)`
- Shared components: `/components/ui` (buttons, forms, modals)
- Hooks: `/hooks` (useAuth, useConsultation, etc)
- Utils: `/lib/utils`, `/lib/services`
- Types: `/types/index.ts` (Prisma-generated types + custom)

**Build Optimization:**

- Tree-shaking (unused code removed)
- Code splitting per route
- Image optimization (WebP, responsive)
- CSS minification
- JS minification + terser


### 2.2 Backend Stack

| Tecnologia | VersÃ£o | FunÃ§Ã£o | Justificativa |
| :-- | :-- | :-- | :-- |
| **Next.js API Routes** | 14+ | Backend framework | Co-located API + frontend, no separate server |
| **TypeScript** | 5.0+ | Type safety | Same benefits as frontend |
| **Node.js** | 18+ LTS | Runtime | LTS version, stable, widely supported |
| **Prisma ORM** | 5.x | Database abstraction | Type-safe queries, migrations, schema generator |
| **PostgreSQL** | 14+ | Database | Relational, JSONB, full-text search, PostGIS ready |
| **NextAuth.js** | 5.x | Authentication | Credentials + OAuth, JWT sessions, built-in CSRF |
| **bcryptjs** | 2.4.x | Password hashing | Industry standard, 10 salt rounds |
| **pino** | 8.x | Logging | Fast JSON logger, streaming support |
| **axios** | 1.x | HTTP client | For external APIs (Whisper, GPT-4o, Gemini) |
| **node-cron** | 3.x | Scheduled jobs | Lightweight, easy syntax for CRON |

**API Architecture:**

- Route handlers in `/api` folder
- Middleware for auth, logging, error handling
- Service layer for business logic
- Prisma models (auto-migration)

**Database Connection:**

```javascript
// lib/prisma.ts - Singleton pattern (avoid multiple connections in dev)
import { PrismaClient } from '@prisma/client'

const globalForPrisma = global as unknown as { prisma: PrismaClient }

export const prisma = globalForPrisma.prisma || new PrismaClient()

if (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma
```


### 2.3 IA Integrations

| API | Model | FunÃ§Ã£o | Custo | Limite |
| :-- | :-- | :-- | :-- | :-- |
| **OpenAI Whisper** | large | Audioâ†’Text (PT-BR) | \$0.006/min | 25 MB max, 60min max |
| **OpenAI GPT-4o** | gpt-4o | ProntuÃ¡rio geraÃ§Ã£o | \$0.003 input, \$0.006 output (1K tokens) | 128K tokens context |
| **Google Gemini** | 2.5-flash | FRED chat + Farejador | Free 15K reqs/day, then \$0.075/1M input tokens | 1M input tokens |
| **Stripe** | v1 API | Payments | 2.9% + R\$ 0.49 per transaction | Depends billing |

**Cost Estimations (Monthly):**

- Whisper: 500 consultations Ã— 30min avg = 250 hours = R\$ 5.40
- GPT-4o: 500 records Ã— 1500 tokens avg = R\$ 2.25
- Gemini: 10K FRED requests/day (free tier covers)
- **Total IA Cost: ~R\$ 10-15/mÃªs** (muito sustentÃ¡vel)

**API Integrations (Code Pattern):**

```typescript
// lib/services/transcriptionService.ts
import { openai } from '@/lib/openai'

export async function transcribeAudio(audioPath: string): Promise<string> {
  try {
    const response = await openai.audio.transcriptions.create({
      file: fs.createReadStream(audioPath),
      model: 'whisper-1',
      language: 'pt', // Portuguese
    })
    return response.text
  } catch (error) {
    // Retry logic + error handling
    throw new TranscriptionError('Failed to transcribe audio')
  }
}

// lib/services/medicalRecordService.ts
export async function generateRecordFromTranscript(
  transcript: string,
  petContext: PetContext
): Promise<MedicalRecordData> {
  const prompt = `
    Extract veterinary consultation data from transcript.
    Pet: ${petContext.name}, Age: ${petContext.age}, Weight: ${petContext.weight}
    Transcript: "${transcript}"
    Return JSON with: complaint, symptoms, examination, diagnosis, etc.
  `
  
  const response = await openai.chat.completions.create({
    model: 'gpt-4o',
    messages: [{ role: 'user', content: prompt }],
    temperature: 0.2, // Low temp (factual, not creative)
    max_tokens: 1000,
  })
  
  // Parse + validate with Zod
  return MedicalRecordSchema.parse(JSON.parse(response.content))
}

// lib/services/fredarService.ts
import { GoogleGenerativeAI } from '@google/generative-ai'

export async function fredarChat(
  userMessage: string,
  context: FredarContext
): Promise<string> {
  const grounded = await searchDatabase(userMessage, context)
  
  const prompt = `
    You are FRED, veterinary AI assistant for ${context.clinic}.
    Context: ${JSON.stringify(grounded)}
    User: "${userMessage}"
    Respond naturally in Portuguese, concisely (2-3 sentences).
  `
  
  const genai = new GoogleGenerativeAI(process.env.GEMINI_API_KEY!)
  const model = genai.getGenerativeModel({ model: 'gemini-2.5-flash' })
  const response = await model.generateContent(prompt)
  
  return response.response.text()
}
```


### 2.4 Storage Architecture

| Tipo | Tecnologia | FunÃ§Ã£o | Justificativa |
| :-- | :-- | :-- | :-- |
| **Banco Dados** | PostgreSQL 14+ | Relational data | ACID, JSONB, full-text search, indexed |
| **File Storage** | MinIO (S3-compatible) | Audio + PDFs + Images | Self-hosted (custo-efetivo), S3 API compatible |
| **Backup** | Backblaze B2 | Off-site backup | Cheap (\$0.006/GB/mth), auto-retention |
| **Cache** | Redis (future Fase 2) | Session + API cache | Sub-millisecond latency |

**MinIO Setup (Docker):**

```yaml
# docker-compose.yml
services:
  minio:
    image: minio/minio:latest
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    volumes:
      - minio-data:/data
    command: minio server /data --console-address ":9001"

volumes:
  minio-data:
```

**File Paths (organized by type):**

```
/clinics/{clinicId}/
â”œâ”€â”€ audios/{consultationId}/
â”‚   â””â”€â”€ original.mp3              # Uploaded file
â”œâ”€â”€ records/{recordId}/
â”‚   â””â”€â”€ signed.pdf                # Generated PDF
â”œâ”€â”€ prescriptions/{prescriptionId}/
â”‚   â””â”€â”€ signed.pdf                # Prescription PDF
â”œâ”€â”€ tutor-avatars/{tutorId}.jpg   # Profile pics
â””â”€â”€ pet-photos/{petId}.jpg        # Pet photos
```

**Cost Analysis (1000 consultations/month):**

- Audio storage: 1000 Ã— 25MB = 25GB â†’ R\$ 0.15/mth
- PDFs: 1000 Ã— 2MB = 2GB â†’ R\$ 0.01/mth
- **Total: ~R\$ 0.20/mth** (negligible)

***

## 3. Database Design (Prisma Schema)

### 3.1 Core Schema Optimization

```prisma
// Key optimization decisions:

// 1. Composite indexes for common queries
model Consultation {
  // ...
  @@index([clinicId, scheduledDate])  // For agenda queries
  @@index([veterinarianId, status])   // For vet filtering
  @@index([petId, createdAt])         // For pet history
}

// 2. Unique constraints (prevent duplicates)
model Tutor {
  // CPF unique per clinic (different clinics can have same person)
  @@unique([clinicId, cpf])
}

// 3. JSONB for flexible metadata
model FredarLog {
  metadata String? @db.JsonB  // Stores {patient_ids, latency, etc}
}

// 4. Soft deletes (logical delete, keep history)
model MedicalRecord {
  deletedAt DateTime?  // If not null = deleted
  
  // Add indexes for soft-delete queries
  @@index([petId, deletedAt])
}

// 5. Relationships with cascade delete (clean up)
model Pet {
  consultations Consultation[]  // If pet deleted, cascade delete consultations
  
  @@relation(onDelete: Cascade)
}
```


### 3.2 Migration Strategy

```bash
# Development
npx prisma migrate dev --name add_consultation_table

# Production
npx prisma migrate deploy  # Runs pending migrations

# Rollback (if needed)
npx prisma migrate resolve --rolled-back migration_name
```


### 3.3 Backup \& Restore

```bash
# Daily backup (CRON 02:00 AM)
pg_dump -h localhost -U postgres fred_db > /backups/fred_$(date +%Y%m%d_%H%M%S).sql

# Upload to B2
b2 sync /backups b2://fred-backups/

# Restore from backup
psql -h localhost -U postgres fred_db < /backups/fred_20251206_020000.sql
```


***

## 4. API Architecture \& Specification

### 4.1 RESTful Conventions

```
Resource-based URLs:
â”œâ”€ GET    /api/consultations              # List all
â”œâ”€ POST   /api/consultations              # Create
â”œâ”€ GET    /api/consultations/{id}         # Get one
â”œâ”€ PUT    /api/consultations/{id}         # Update
â”œâ”€ POST   /api/consultations/{id}/cancel  # Action endpoint
â””â”€ DELETE /api/consultations/{id}         # Delete (soft-delete)

Status Codes:
â”œâ”€ 200 OK                  (Success)
â”œâ”€ 201 Created             (Created resource)
â”œâ”€ 204 No Content          (Success, no response body)
â”œâ”€ 400 Bad Request         (Validation error)
â”œâ”€ 401 Unauthorized        (Missing/invalid JWT)
â”œâ”€ 403 Forbidden           (Insufficient permissions)
â”œâ”€ 404 Not Found           (Resource doesn't exist)
â”œâ”€ 409 Conflict            (Duplicate/conflict)
â””â”€ 500 Server Error        (Unexpected error)
```


### 4.2 Request/Response Format

```typescript
// SUCCESS Response
{
  success: true,
  data: {
    id: "...",
    name: "...",
    // ... resource fields
  },
  message: "Consultation created successfully"
}

// ERROR Response
{
  success: false,
  error: {
    code: "VALIDATION_ERROR",
    message: "Invalid email format",
    details: {
      field: "email",
      reason: "Must be valid email"
    }
  }
}

// PAGINATED Response
{
  success: true,
  data: [...],
  pagination: {
    page: 1,
    pageSize: 20,
    total: 150,
    pages: 8
  }
}
```


### 4.3 Authentication Flow

```
1. POST /api/auth/login
   Request: { email, password }
   Response: { accessToken, refreshToken, user }
   
2. Client stores tokens (accessToken in memory, refreshToken in httpOnly cookie)

3. Every request includes Authorization header:
   Authorization: Bearer {accessToken}
   
4. Middleware verifies JWT:
   - Check signature
   - Check expiration
   - Extract userId + role
   - Attach to request context
   
5. If accessToken expires:
   POST /api/auth/refresh-token
   Request: { refreshToken }
   Response: { newAccessToken }

6. POST /api/auth/logout
   Response: Clear cookies, invalidate refresh token
```


### 4.4 Sample API Endpoints Detail

```typescript
// POST /api/consultations - Create Consultation

Request:
{
  petId: "uuid",
  tutorId: "uuid",
  veterinarianId: "uuid",
  type: "routine",
  scheduledDate: "2025-12-10T14:00:00Z",
  notes: "Annual checkup"
}

Response (201 Created):
{
  success: true,
  data: {
    id: "uuid",
    petId: "uuid",
    tutorId: "uuid",
    veterinarianId: "uuid",
    type: "routine",
    scheduledDate: "2025-12-10T14:00:00Z",
    status: "scheduled",
    notes: "Annual checkup",
    tutorNotified: true,
    createdAt: "2025-12-06T03:31:00Z",
    updatedAt: "2025-12-06T03:31:00Z"
  },
  message: "Consultation created. Tutor notified."
}

Error (400 Bad Request - Conflict):
{
  success: false,
  error: {
    code: "SCHEDULING_CONFLICT",
    message: "Veterinarian already has consultation at this time",
    details: {
      existingConsultation: "uuid",
      requestedTime: "2025-12-10T14:00:00Z"
    }
  }
}

---

// POST /api/consultations/{id}/cancel - Cancel with reason

Request:
{
  reason: "no-show",
  notes: "Tutor didn't show up"
}

Response (200 OK):
{
  success: true,
  data: {
    id: "uuid",
    status: "cancelled",
    cancellationReason: "no-show",
    // ... rest of consultation data
  },
  message: "Consultation cancelled. Tutor notified of cancellation."
}

---

// POST /api/transcription/upload - Upload audio file

Request:
FormData:
  file: <binary MP3/WAV/M4A file, max 50MB>
  consultationId: "uuid"

Response (200 OK):
{
  success: true,
  data: {
    audioId: "uuid",
    fileName: "consultation_20251206.mp3",
    fileSize: 12500000,  // bytes
    status: "processing",
    message: "Audio uploaded. Processing started. You'll be notified when ready."
  }
}

Error (413 Payload Too Large):
{
  success: false,
  error: {
    code: "FILE_TOO_LARGE",
    message: "File exceeds 50MB limit",
    details: {
      maxSize: 52428800,
      providedSize: 75000000
    }
  }
}

---

// POST /api/records/generate-from-transcript - Generate medical record from audio

Request:
{
  consultationId: "uuid",
  audioPath: "audios/clinic/consultation_id/original.mp3"
}

Response (202 Accepted - Async processing):
{
  success: true,
  data: {
    recordId: "uuid",
    status: "processing",
    estimatedTime: "2-5 minutes"
  },
  message: "Record generation started. You'll receive notification when ready."
}

Webhook (when ready):
POST {client_webhook_url}
{
  event: "record_generated",
  recordId: "uuid",
  status: "ready_for_review",
  data: {
    complaint: "Vomiting for 2 days",
    symptoms: "...",
    diagnosis: "Gastroenteritis - suspected",
    // ... all extracted fields
  }
}

---

// GET /api/fredar/search-patient?q=rex - Natural search

Request:
GET /api/fredar/search-patient?q=rex&type=pet

Response (200 OK):
{
  success: true,
  data: {
    results: [
      {
        type: "pet",
        id: "uuid",
        name: "Rex",
        species: "dog",
        breed: "Labrador",
        age: "5 years",
        tutorName: "JoÃ£o Silva",
        lastConsultation: {
          date: "2025-11-15",
          veterinarian: "Dra. Maria",
          type: "routine"
        }
      }
    ],
    count: 1
  }
}

---

// POST /api/fredar/chat - Send FRED chat message

Request:
{
  message: "Qual foi o Ãºltimo exame do Rex?",
  conversationId: "uuid"  // optional, for history
}

Response (200 OK):
{
  success: true,
  data: {
    message: "O Ãºltimo exame do Rex foi em 15/11...",
    conversationId: "uuid",
    actions: [
      {
        type: "button",
        label: "Ver completo",
        action: "navigateTo",
        target: "/records/uuid"
      }
    ]
  }
}
```


***

## 5. External Integrations

### 5.1 OpenAI Integration

```typescript
// lib/openai.ts
import OpenAI from 'openai'

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
  timeout: 300 * 1000, // 5 min for Whisper
})

// Whisper (async, retryable)
export async function transcribeAudio(filePath: string, maxRetries = 3) {
  for (let i = 0; i < maxRetries; i++) {
    try {
      const transcription = await openai.audio.transcriptions.create({
        file: fs.createReadStream(filePath),
        model: 'whisper-1',
        language: 'pt',
        prompt: 'Medical/veterinary consultation notes',
      })
      return transcription.text
    } catch (error) {
      if (i === maxRetries - 1) {
        // Last retry failed, store for manual retry
        await storeFailedTranscription(filePath)
        throw new TranscriptionError('Max retries exceeded')
      }
      await sleep(2000 * (i + 1)) // Exponential backoff
    }
  }
}

// GPT-4o (medical record generation)
export async function generateMedicalRecord(
  transcript: string,
  petContext: object,
  previousRecords: string
) {
  const systemPrompt = `
    You are a veterinary medical record assistant.
    Extract only factual information from the consultation transcript.
    Do not fabricate or infer information not explicitly stated.
    Return valid JSON.
  `
  
  const userPrompt = `
    Pet context: ${JSON.stringify(petContext)}
    Previous records: ${previousRecords}
    
    From this transcript, extract medical information:
    "${transcript}"
    
    Return JSON with: {
      complaint, symptoms, examination, diagnosis, 
      differentialDx, testsOrdered, medications, 
      instructions, nextReturnDate, notes
    }
  `
  
  const response = await openai.chat.completions.create({
    model: 'gpt-4o',
    messages: [
      { role: 'system', content: systemPrompt },
      { role: 'user', content: userPrompt },
    ],
    temperature: 0.2,
    max_tokens: 1500,
    response_format: { type: 'json_object' },
  })
  
  return MedicalRecordSchema.parse(
    JSON.parse(response.choices[0].message.content)
  )
}

// Cost monitoring
export async function logAPICost(
  service: 'whisper' | 'gpt4o',
  usage: object,
  cost: number
) {
  await db.apiCostLog.create({
    data: { service, usage, cost, date: new Date() },
  })
  
  // Alert if monthly cost exceeds threshold
  const monthCost = await db.apiCostLog.aggregate({
    where: {
      date: { gte: getMonthStart() },
    },
    _sum: { cost: true },
  })
  
  if (monthCost._sum.cost > 500) { // R$ 500 threshold
    sendAlert('API cost exceeding threshold')
  }
}
```


### 5.2 Google Gemini Integration

```typescript
// lib/gemini.ts
import { GoogleGenerativeAI } from '@google/generative-ai'

const genai = new GoogleGenerativeAI(process.env.GEMINI_API_KEY!)

// FRED Chat with grounding
export async function fredarChat(
  userMessage: string,
  userId: string,
  clinicId: string,
  conversationHistory: Message[]
) {
  // 1. Grounding: Search DB first
  const groundedContext = await groundMessageInDatabase(
    userMessage,
    clinicId
  )
  
  if (!groundedContext.found) {
    return {
      message: `Desculpe, nÃ£o encontrei "${groundedContext.searchTerm}". Quer que eu...?`,
      actions: [
        { label: 'Agendar novo pet', action: 'openModal', target: 'newPet' },
        { label: 'Buscar novamente', action: 'chat', target: null },
      ],
    }
  }
  
  // 2. Build context for Gemini
  const systemPrompt = `
    You are FRED, a veterinary AI assistant for ${clinic.name}.
    - Respond in Portuguese (Brasil)
    - Be concise and helpful
    - Suggest next actions when relevant
    - Never fabricate patient data
    - If asked about medical facts, provide factual info but suggest vet consultation
  `
  
  const contextMessage = `
    Current context:
    ${JSON.stringify(groundedContext, null, 2)}
    
    Recent conversation history:
    ${conversationHistory.slice(-5).map((m) => `${m.role}: ${m.content}`).join('\n')}
  `
  
  // 3. Call Gemini
  const model = genai.getGenerativeModel({
    model: 'gemini-2.5-flash',
    systemInstruction: systemPrompt,
  })
  
  const response = await model.generateContent([
    { text: contextMessage },
    { text: userMessage },
  ])
  
  const responseText = response.response.text()
  
  // 4. Log for audit
  await logFredarMessage({
    userId,
    clinicId,
    userMessage,
    fredResponse: responseText,
    context: groundedContext,
    timestamp: new Date(),
  })
  
  return {
    message: responseText,
    actions: extractActions(responseText),
  }
}

// Farejador: Gemini Grounding Search
export async function farejadorScanCompetitors(
  clinicId: string,
  competitors: Competitor[]
) {
  const results = []
  
  for (const competitor of competitors) {
    try {
      const model = genai.getGenerativeModel({
        model: 'gemini-2.5-flash',
      })
      
      // Use Google Search integration (if available, else manual search)
      const searchQuery = `
        veterinary clinic "${competitor.name}" 
        "${competitor.city}" 
        site:google.com | site:instagram.com | site:facebook.com
      `
      
      const response = await model.generateContent(`
        Search for recent updates about this veterinary clinic:
        Name: ${competitor.name}
        Location: ${competitor.address}
        
        Find: current rating, recent reviews, social media activity, 
        website updates, new services offered.
        
        Return JSON: {
          rating, reviewCount, lastReviewDate, recentPosts, updates
        }
      `)
      
      const data = parseJSON(response.response.text())
      results.push({
        competitorId: competitor.id,
        ...data,
        lastFetch: new Date(),
      })
    } catch (error) {
      console.error(`Failed to scan ${competitor.name}:`, error)
      results.push({
        competitorId: competitor.id,
        error: 'Failed to fetch',
        lastFetch: new Date(),
      })
    }
  }
  
  return results
}

// Cost monitoring
export async function logGeminiUsage(
  tokens: number,
  type: 'input' | 'output',
  cost: number
) {
  await db.geminiUsageLog.create({
    data: { tokens, type, cost, date: new Date() },
  })
}
```


### 5.3 Stripe Integration

```typescript
// lib/stripe.ts
import Stripe from 'stripe'

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {
  apiVersion: '2024-04-10',
})

// Create subscription
export async function createSubscription(
  clinicId: string,
  plan: 'starter' | 'professional' | 'enterprise'
) {
  const priceIds = {
    starter: 'price_xxxxx',
    professional: 'price_yyyyy',
    enterprise: 'price_zzzzz',
  }
  
  const clinic = await db.clinic.findUnique({ where: { id: clinicId } })
  
  const customer = await stripe.customers.create({
    email: clinic.admin.email,
    metadata: { clinicId },
  })
  
  const subscription = await stripe.subscriptions.create({
    customer: customer.id,
    items: [{ price: priceIds[plan] }],
    payment_behavior: 'default_incomplete',
    collection_method: 'charge_automatically',
    metadata: { clinicId, plan },
  })
  
  // Save to DB
  await db.subscription.create({
    data: {
      clinicId,
      plan,
      stripeCustomerId: customer.id,
      stripeSubscriptionId: subscription.id,
      status: 'trial',
      trialStartDate: new Date(),
      trialEndDate: addDays(new Date(), 14),
      nextBillingDate: subscription.current_period_end,
      monthlyPrice: getPriceAmount(plan),
    },
  })
  
  return {
    subscriptionId: subscription.id,
    clientSecret: subscription.client_secret,
  }
}

// Webhook handler
export async function handleStripeWebhook(event: Stripe.Event) {
  switch (event.type) {
    case 'customer.subscription.updated':
      const subscription = event.data.object as Stripe.Subscription
      await db.subscription.update({
        where: {
          stripeSubscriptionId: subscription.id,
        },
        data: {
          status: subscription.status,
          nextBillingDate: subscription.current_period_end,
        },
      })
      break
      
    case 'payment_intent.payment_failed':
      const paymentIntent = event.data.object as Stripe.PaymentIntent
      await notifyPaymentFailed(paymentIntent.metadata.clinicId)
      break
      
    // ... other events
  }
}

// Cancel subscription
export async function cancelSubscription(clinicId: string) {
  const subscription = await db.subscription.findUnique({
    where: { clinicId },
  })
  
  await stripe.subscriptions.update(
    subscription!.stripeSubscriptionId!,
    { cancel_at_period_end: true }
  )
  
  await db.subscription.update({
    where: { clinicId },
    data: {
      cancellationReason: 'User requested',
      status: 'cancelled',
    },
  })
}
```


***

## 6. Infrastructure \& DevOps

### 6.1 VPS Configuration (Hostinger + Coolify)

```bash
# Initial setup
1. Buy VPS Ubuntu 22.04 LTS (8GB RAM, 160GB SSD recommended)
2. SSH access: ssh root@ip_address
3. Update system:
   apt update && apt upgrade -y
4. Install Docker + Docker Compose
5. Install Coolify via script

# Coolify deployment
- Connect GitHub repo
- Configure environment variables
- Set up SSL/TLS (Let's Encrypt via Coolify)
- Configure backup retention
- Set up monitoring/alerts
```


### 6.2 Docker Compose Architecture

```yaml
# docker-compose.yml

version: '3.9'

services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: ${DB_NAME}
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # MinIO S3-compatible storage
  minio:
    image: minio/minio:latest
    environment:
      MINIO_ROOT_USER: ${MINIO_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_PASSWORD}
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio-data:/data
    command: minio server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  # Next.js Application
  app:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      NODE_ENV: production
      DATABASE_URL: postgresql://${DB_USER}:${DB_PASSWORD}@postgres:5432/${DB_NAME}
      MINIO_ENDPOINT: minio:9000
      NEXTAUTH_URL: ${NEXTAUTH_URL}
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY}
    ports:
      - "3000:3000"
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - app
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  postgres-data:
  minio-data:
```


### 6.3 CI/CD Pipeline (GitHub Actions)

```yaml
# .github/workflows/deploy.yml

name: Deploy to Production

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v3
      
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - run: npm ci
      
      - run: npm run lint
      
      - run: npm run type-check
      
      - run: npm run test:unit
      
      - run: npm run test:e2e
        env:
          DATABASE_URL: postgres://postgres:postgres@localhost:5432/test

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - uses: actions/checkout@v3
      
      - name: Deploy to Coolify
        run: |
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.COOLIFY_API_TOKEN }}" \
            -d '{"ref":"main"}' \
            https://coolify.example.com/api/v1/applications/deploy
      
      - name: Health Check
        run: |
          for i in {1..30}; do
            if curl -f https://fred.example.com/api/health; then
              echo "Deployment successful"
              exit 0
            fi
            sleep 10
          done
          exit 1
      
      - name: Alert on Failure
        if: failure()
        run: |
          curl -X POST https://discord.com/api/webhooks/... \
            -H "Content-Type: application/json" \
            -d '{"content":"Deployment failed!"}'
```


### 6.4 Monitoring \& Logging

```typescript
// lib/monitoring.ts

import * as Sentry from '@sentry/nextjs'
import logger from 'pino'

// Sentry for error tracking
Sentry.init({
  dsn: process.env.SENTRY_DSN,
  environment: process.env.NODE_ENV,
  tracesSampleRate: 0.1,
})

// Pino for structured logging
export const log = logger({
  level: process.env.LOG_LEVEL || 'info',
  transport: {
    target: 'pino-pretty',
    options: { colorize: true },
  },
})

// Usage in routes
export async function logRequest(req: Request, res: Response, duration: number) {
  log.info({
    method: req.method,
    path: req.url,
    statusCode: res.status,
    duration: `${duration}ms`,
    timestamp: new Date().toISOString(),
  })
}

// Error handling
export function captureException(error: Error, context: object) {
  Sentry.captureException(error, { contexts: { context } })
  log.error({ error: error.message, stack: error.stack, ...context })
}
```


***

## 7. Security Architecture

### 7.1 LGPD Compliance

```typescript
// lib/lgpd.ts

// Data minimization: Collect only what's necessary
const REQUIRED_FIELDS = {
  tutor: ['name', 'email', 'phone'],
  pet: ['name', 'species'],
  medicalRecord: ['diagnosis', 'treatment'],
  // Not required: Income, marital status, etc
}

// Consent management
export async function recordConsent(
  userId: string,
  type: 'terms' | 'privacy' | 'marketing'
) {
  await db.consentLog.create({
    data: {
      userId,
      type,
      timestamp: new Date(),
      ipAddress: getClientIP(),
      userAgent: getUserAgent(),
    },
  })
}

// Right to be forgotten
export async function deleteUser(userId: string) {
  const user = await db.user.findUnique({ where: { id: userId } })
  
  // 1. Delete personal data
  await db.tutor.deleteMany({ where: { userId } })
  await db.user.delete({ where: { id: userId } })
  
  // 2. Keep audit logs (anonymized)
  await db.auditLog.updateMany({
    where: { userId },
    data: { userId: 'DELETED_USER' },
  })
  
  // 3. Notify data deletion
  await sendDataDeletionEmail(user.email)
  
  log.info(`User ${userId} deleted (LGPD compliance)`)
}

// Data portability
export async function exportUserData(userId: string) {
  const data = {
    user: await db.user.findUnique({ where: { id: userId } }),
    tutors: await db.tutor.findMany({ where: { userId } }),
    pets: await db.pet.findMany({ where: { tutor: { userId } } }),
    consultations: await db.consultation.findMany({
      where: { tutor: { userId } },
    }),
    // ... all user data
  }
  
  return JSON.stringify(data, null, 2)
}
```


### 7.2 Encryption Strategy

```typescript
// lib/encryption.ts

import crypto from 'crypto'

const ALGORITHM = 'aes-256-gcm'
const ENCRYPTION_KEY = Buffer.from(process.env.ENCRYPTION_KEY!, 'hex')

// Encrypt sensitive fields
export function encrypt(data: string): string {
  const iv = crypto.randomBytes(16)
  const cipher = crypto.createCipheriv(ALGORITHM, ENCRYPTION_KEY, iv)
  
  let encrypted = cipher.update(data, 'utf8', 'hex')
  encrypted += cipher.final('hex')
  
  const authTag = cipher.getAuthTag()
  
  return `${iv.toString('hex')}:${encrypted}:${authTag.toString('hex')}`
}

// Decrypt sensitive fields
export function decrypt(encryptedData: string): string {
  const [ivHex, encrypted, authTagHex] = encryptedData.split(':')
  
  const iv = Buffer.from(ivHex, 'hex')
  const authTag = Buffer.from(authTagHex, 'hex')
  
  const decipher = crypto.createDecipheriv(ALGORITHM, ENCRYPTION_KEY, iv)
  decipher.setAuthTag(authTag)
  
  let decrypted = decipher.update(encrypted, 'hex', 'utf8')
  decrypted += decipher.final('utf8')
  
  return decrypted
}

// Usage in Prisma middleware
prisma.$use(async (params, next) => {
  const result = await next(params)
  
  // Decrypt CPF on retrieval
  if (params.model === 'Tutor' && result) {
    result.cpf = decrypt(result.cpf)
  }
  
  return result
})
```


### 7.3 RBAC Implementation

```typescript
// lib/rbac.ts

const PERMISSIONS = {
  admin: [
    'manage_users',
    'view_financials',
    'access_settings',
    'manage_clinic_info',
  ],
  veterinarian: [
    'view_own_patients',
    'edit_own_records',
    'create_prescriptions',
    'access_fredar',
  ],
  attendant: [
    'create_tutors',
    'create_pets',
    'manage_schedule',
    'basic_fredar_search',
  ],
}

export function hasPermission(
  userRole: string,
  requiredPermission: string
): boolean {
  return PERMISSIONS[userRole]?.includes(requiredPermission) ?? false
}

// Middleware
export async function requirePermission(
  req: Request,
  res: Response,
  permission: string
) {
  const session = await getSession({ req })
  
  if (!session) {
    return res.status(401).json({ error: 'Unauthorized' })
  }
  
  if (!hasPermission(session.user.role, permission)) {
    return res.status(403).json({ error: 'Forbidden' })
  }
}
```


***

## 8. Performance \& Scalability

### 8.1 Performance Targets

```
Web Vitals (Google Lighthouse):
â”œâ”€ Largest Contentful Paint (LCP): <2.5s
â”œâ”€ First Input Delay (FID): <100ms
â”œâ”€ Cumulative Layout Shift (CLS): <0.1
â”œâ”€ Time to First Byte (TTFB): <600ms
â””â”€ Overall Score: >85 mobile, >90 desktop

API Performance:
â”œâ”€ Response time (p95): <200ms
â”œâ”€ Database query (p95): <100ms
â”œâ”€ File upload (1GB): <2 minutes
â””â”€ Concurrent users: 100+

Scalability:
â”œâ”€ Max consultations/day: 1,000+
â”œâ”€ Max concurrent users: 50+
â”œâ”€ Database size: 100GB+ (managed)
â””â”€ File storage: Unlimited (S3-compatible)
```


### 8.2 Caching Strategy

```typescript
// lib/cache.ts

// Browser caching (Next.js built-in)
export const CACHE_HEADERS = {
  static: 'public, max-age=31536000', // 1 year
  dynamic: 'private, max-age=60', // 1 minute
  api: 'private, no-cache',
}

// API response caching (Redis future)
export async function cachedQuery(
  key: string,
  fn: () => Promise<any>,
  ttl: number = 3600 // seconds
) {
  const cached = await redis.get(key)
  if (cached) return JSON.parse(cached)
  
  const result = await fn()
  await redis.setex(key, ttl, JSON.stringify(result))
  
  return result
}

// Database query optimization
export const consultationQuery = {
  include: {
    pet: true,
    tutor: true,
    medicalRecord: true,
  },
  // Only fields needed, not all
  select: {
    id: true,
    scheduledDate: true,
    status: true,
    pet: { select: { name: true, species: true } },
    tutor: { select: { name: true, email: true } },
  },
}
```


### 8.3 Database Optimization

```sql
-- Key indexes (Prisma migrations)
CREATE INDEX idx_consultations_clinic_scheduled 
  ON consultations(clinic_id, scheduled_date);

CREATE INDEX idx_consultations_vet_status 
  ON consultations(veterinarian_id, status);

CREATE INDEX idx_medical_records_pet_date 
  ON medical_records(pet_id, created_at DESC);

CREATE INDEX idx_pets_tutor_active 
  ON pets(tutor_id, active);

-- Connection pooling (Prisma)
datasource db {
  provider = "postgresql"
  url = env("DATABASE_URL")
  extensions = [pgcrypto]
}

generator client {
  provider = "prisma-client-js"
  engineType = "binary"
}

-- Query optimization
-- Instead of: SELECT * FROM consultations
-- Use: SELECT id, scheduled_date, status FROM consultations

-- Batch operations
-- Instead of: 100 individual INSERT queries
-- Use: INSERT INTO ... VALUES (...), (...), (...);
```


***

## 9. CRON Jobs \& Background Tasks

### 9.1 Job Architecture

```typescript
// lib/jobs/scheduler.ts

import cron from 'node-cron'

// Job definitions
const JOBS = {
  fredarJournal: '0 6 * * *', // Daily 06:00 AM
  reminders: '*/30 * * * *', // Every 30 minutes
  backup: '0 2 * * *', // Daily 02:00 AM
  cleanup: '0 3 * * *', // Daily 03:00 AM
}

// Initialize scheduler
export function initializeScheduler() {
  cron.schedule(JOBS.fredarJournal, async () => {
    console.log('[CRON] Running Fredar Journal job...')
    await runFredarJournalJob()
  })
  
  cron.schedule(JOBS.reminders, async () => {
    console.log('[CRON] Running Reminders job...')
    await runRemindersJob()
  })
  
  cron.schedule(JOBS.backup, async () => {
    console.log('[CRON] Running Backup job...')
    await runBackupJob()
  })
  
  cron.schedule(JOBS.cleanup, async () => {
    console.log('[CRON] Running Cleanup job...')
    await runCleanupJob()
  })
}

// Fredar Journal job
async function runFredarJournalJob() {
  try {
    const clinics = await db.clinic.findMany()
    
    for (const clinic of clinics) {
      const data = await CompetitorService.generateJournal(clinic.id)
      
      await db.fredarJournal.create({
        data: {
          clinicId: clinic.id,
          journalDate: new Date(),
          clinicSection: JSON.stringify(data.clinic),
          localSection: JSON.stringify(data.local),
          competitorSection: JSON.stringify(data.competitors),
          opportunitiesSection: JSON.stringify(data.opportunities),
        },
      })
      
      // Send email
      await NotificationService.sendEmail({
        to: clinic.adminEmail,
        template: 'fredar-journal',
        data,
      })
    }
    
    log.info(`[CRON] Fredar Journal completed for ${clinics.length} clinics`)
  } catch (error) {
    Sentry.captureException(error)
    log.error('[CRON] Fredar Journal job failed', error)
  }
}

// Reminders job
async function runRemindersJob() {
  try {
    const now = new Date()
    const in1Hour = new Date(now.getTime() + 60 * 60 * 1000)
    const in1Day = new Date(now.getTime() + 24 * 60 * 60 * 1000)
    
    // Get consultations that need reminders
    const consultations = await db.consultation.findMany({
      where: {
        status: 'scheduled',
        scheduledDate: {
          gte: now,
          lte: in1Hour,
        },
      },
      include: { pet: true, tutor: true, veterinarian: true },
    })
    
    for (const consultation of consultations) {
      // Send email reminder
      await NotificationService.sendEmail({
        to: consultation.tutor.email,
        template: 'reminder',
        data: {
          petName: consultation.pet.name,
          vetName: consultation.veterinarian.name,
          time: consultation.scheduledDate.toLocaleTimeString('pt-BR'),
        },
      })
      
      // Send SMS (if enabled)
      if (consultation.tutor.phoneWhatsapp) {
        await NotificationService.sendSMS({
          to: consultation.tutor.phone,
          message: `Consulta de ${consultation.pet.name} com ${consultation.veterinarian.name} em 1 hora!`,
        })
      }
    }
    
    log.info(`[CRON] Sent ${consultations.length} reminder notifications`)
  } catch (error) {
    Sentry.captureException(error)
    log.error('[CRON] Reminders job failed', error)
  }
}

// Backup job
async function runBackupJob() {
  try {
    // Backup PostgreSQL
    const backupFile = `/backups/fred_${new Date().toISOString().split('T')[0]}.sql`
    
    const command = `pg_dump -h ${DB_HOST} -U ${DB_USER} ${DB_NAME} > ${backupFile}`
    await exec(command)
    
    // Compress
    await exec(`gzip ${backupFile}`)
    
    // Upload to B2
    await uploadToB2(`${backupFile}.gz`, `database/fred_${Date.now()}.sql.gz`)
    
    // Keep only last 30 days locally
    const files = await fs.promises.readdir('/backups')
    const thirtyDaysAgo = Date.now() - 30 * 24 * 60 * 60 * 1000
    
    for (const file of files) {
      const filepath = `/backups/${file}`
      const stats = await fs.promises.stat(filepath)
      if (stats.mtimeMs < thirtyDaysAgo) {
        await fs.promises.unlink(filepath)
      }
    }
    
    log.info('[CRON] Backup completed')
  } catch (error) {
    Sentry.captureException(error)
    log.error('[CRON] Backup job failed', error)
    sendAlert('Database backup failed!')
  }
}

// Cleanup job
async function runCleanupJob() {
  try {
    // Delete failed transcriptions older than 7 days
    const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)
    
    const failed = await db.transcriptionError.deleteMany({
      where: { createdAt: { lt: sevenDaysAgo } },
    })
    
    log.info(`[CRON] Cleanup deleted ${failed.count} old transcription errors`)
  } catch (error) {
    log.error('[CRON] Cleanup job failed', error)
  }
}
```


***

## 10. Architecture Decision Records (ADRs)

### ADR-1: Next.js 14 App Router vs Pages Router

**Decision:** Use Next.js 14 App Router (not Pages Router)

**Rationale:**

- Streaming Server Components for better performance
- Built-in layouts for shared UI
- Better TypeScript support
- Concurrent Features (React 18+)
- Modern React patterns

**Trade-offs:**

- Slightly steeper learning curve
- Some third-party libraries not yet compatible
- Mitigation: Use Next.js 13.5+ for maximum compatibility

***

### ADR-2: PostgreSQL + Prisma vs MongoDB

**Decision:** PostgreSQL + Prisma ORM

**Rationale:**

- ACID transactions (critical for medical records)
- Relational data (vets, patients, records have clear relationships)
- Full-text search capability
- Strong consistency (no eventual consistency issues)
- Prisma provides type safety + migrations

**Trade-offs:**

- Slightly more complex schema design
- Not suitable for unstructured data (but we don't need it)

***

### ADR-3: Self-Hosted MinIO vs AWS S3

**Decision:** Self-hosted MinIO (S3-compatible)

**Rationale:**

- 50-60% cost savings vs AWS S3
- Easy migration to S3 later (same API)
- Full control over data location (important for LGPD)
- No vendor lock-in

**Trade-offs:**

- Need to manage infrastructure
- Mitigation: Deploy via Coolify (automated)

***

### ADR-4: Coolify vs Vercel for Deployment

**Decision:** Coolify on VPS (not Vercel)

**Rationale:**

- Lower costs (\$10-15/month VPS vs \$200+ Vercel)
- Full server control (needed for CRON jobs, Node.js services)
- No serverless cold starts (important for real-time responsiveness)
- Better for long-running background tasks

**Trade-offs:**

- More DevOps maintenance
- Mitigation: Coolify abstracts most complexity

***

### ADR-5: Gemini 2.5 Flash vs GPT-4 for FRED Chat

**Decision:** Gemini 2.5 Flash (not GPT-4)

**Rationale:**

- 10x faster response (sub-second)
- Lower cost (\$0.075/1M vs \$15/1M for GPT-4)
- Native Grounding Search (prevent hallucinations)
- Real-time performance critical for chat UX

**Trade-offs:**

- Slightly less sophisticated responses
- Mitigation: Temperature 0.2 + grounding prevents issues

***

### ADR-6: NextAuth.js vs Auth0 / Firebase Auth

**Decision:** NextAuth.js

**Rationale:**

- Zero vendor lock-in
- Open source (can self-host if needed)
- Tight Next.js integration
- No monthly costs

**Trade-offs:**

- More setup than managed solutions
- Need to maintain JWT rotation
- Mitigation: Well-documented, large community

***

### ADR-7: Single Database vs Sharding

**Decision:** Single PostgreSQL database (for MVP)

**Rationale:**

- MVP scope: 100-200 clinics max
- Single DB sufficient
- Sharding adds complexity
- Migration path exists if needed (Citus extension)

***

### ADR-8: Real-time Chat vs Polling

**Decision:** Polling (not WebSockets)

**Rationale:**

- FRED chat not critical real-time (5-10s delay acceptable)
- Simpler infrastructure (no websocket server)
- Better for variable network conditions
- Can upgrade to WebSockets later (Ably service)

***

### ADR-9: Email + SMS vs Push Notifications Only

**Decision:** Email + SMS (future: WhatsApp)

**Rationale:**

- Email universal (no app download needed)
- SMS 99%+ delivery for time-critical (reminders)
- SMS works offline
- WhatsApp integration Fase 2

***

### ADR-10: Medical Record Immutability

**Decision:** Soft delete only (never hard delete), versioning if edited

**Rationale:**

- Legal requirement (CFMV)
- Audit trail important for liability
- Cannot lose medical history

***

### ADR-11: Separate Tutor Portal vs In-app Access

**Decision:** Web-based tutor portal (not mobile app MVP)

**Rationale:**

- Simpler infrastructure (no app store submissions)
- Responsive design covers mobile
- MVP scope constraint
- Mobile app Fase 2

***

### ADR-12: Synchronous Transcription vs Async

**Decision:** Async transcription (webhook notify when ready)

**Rationale:**

- Whisper takes 2-5 minutes (can't wait synchronously)
- Better UX (immediate response, notification later)
- Allows retry logic
- Scales better

***

## 11. Testing Strategy

### 11.1 Test Pyramid

```
                    E2E (Playwright)
                  /    |     |     \
               /        |     |       \
            Integration Tests (API routes)
          /            |     |      \
       /               |     |        \
    Unit Tests (functions, components)
   /                    |     |         \

Target: 80% coverage (unit), 30% E2E
```


### 11.2 Unit Tests

```typescript
// __tests__/lib/services/medicalRecordService.test.ts

import { generateMedicalRecord } from '@/lib/services/medicalRecordService'
import { MedicalRecordSchema } from '@/lib/schemas'

describe('medicalRecordService.generateMedicalRecord', () => {
  it('should extract chief complaint from transcript', async () => {
    const transcript = 'O pet chegou vomitando hÃ¡ 2 dias'
    const result = await generateMedicalRecord(transcript, {}, '')
    
    expect(result.complaint).toContain('vomit')
  })
  
  it('should validate schema', async () => {
    const result = await generateMedicalRecord('', {}, '')
    expect(() => MedicalRecordSchema.parse(result)).not.toThrow()
  })
  
  it('should not hallucinate if transcript empty', async () => {
    const result = await generateMedicalRecord('', {}, '')
    expect(result.complaint).toBe('')
  })
})
```


### 11.3 API Integration Tests

```typescript
// __tests__/api/consultations.test.ts

import { POST } from '@/app/api/consultations/route'

describe('POST /api/consultations', () => {
  it('should create consultation', async () => {
    const req = new Request('http://localhost:3000/api/consultations', {
      method: 'POST',
      body: JSON.stringify({
        petId: 'pet1',
        tutorId: 'tutor1',
        veterinarianId: 'vet1',
        type: 'routine',
        scheduledDate: new Date().toISOString(),
      }),
    })
    
    const res = await POST(req)
    expect(res.status).toBe(201)
    
    const data = await res.json()
    expect(data.success).toBe(true)
    expect(data.data.id).toBeDefined()
  })
  
  it('should reject duplicate time slots', async () => {
    // ... create first consultation
    // ... try to create another at same time
    // ... expect 409 Conflict
  })
})
```


### 11.4 E2E Tests

```typescript
// e2e/vet-creates-consultation.spec.ts

import { test, expect } from '@playwright/test'

test.describe('Vet creates consultation', () => {
  test.beforeEach(async ({ page }) => {
    // Login as vet
    await page.goto('/login')
    await page.fill('[name="email"]', 'vet@example.com')
    await page.fill('[name="password"]', 'password123')
    await page.click('button[type="submit"]')
    await page.waitForURL('/dashboard')
  })
  
  test('should create new consultation', async ({ page }) => {
    await page.click('button:has-text("Nova Consulta")')
    
    // Fill form
    await page.click('[name="petId"]')
    await page.selectOption('[name="petId"]', 'pet-123')
    
    await page.click('[name="scheduledDate"]')
    await page.fill('[type="date"]', '2025-12-10')
    
    await page.click('button:has-text("Salvar")')
    
    // Verify success
    await expect(page.locator('text=Consulta criada com sucesso')).toBeVisible()
  })
})
```


***

## 12. Disaster Recovery \& Backup

### 12.1 3-2-1 Backup Rule

**3 copies** of critical data

- Daily: PostgreSQL dump (disk)
- Daily: MinIO snapshot (disk)
- Weekly: Archive to Backblaze B2

**2 different media**

- SSD local storage
- Cloud object storage (B2)

**1 offsite**

- Backblaze B2 (geographically distant)


### 12.2 Restore Procedure

```bash
# Test monthly (documented):

1. Stop application
   docker-compose down

2. Restore database
   psql -h localhost -U postgres fred_db < backup.sql

3. Restore MinIO
   mc mirror b2://fred-backups minio/fred

4. Start application
   docker-compose up -d

5. Verify
   curl https://fred.example.com/api/health
   Check a patient record
   Verify audio files accessible
```


***

## 13. Implementation Timeline \& Dependencies

### Front-End (UI Layer)

- âœ… Foundational: Week 1-2 (setup, auth UI)
- âœ… Agenda: Week 3-4 (calendar, modals)
- âœ… Records: Week 5-6 (forms, history)
- âœ… FRED Chat: Week 7-8 (component, styling)
- âœ… Farejador: Week 9-10 (dashboard, graphs)
- âœ… Optimization: Week 11-12 (performance, accessibility)


### Back-End (API Layer)

- âœ… Database: Week 1-2 (schema, migrations, Prisma)
- âœ… Auth: Week 2-3 (NextAuth.js, JWT, RBAC)
- âœ… Consultation CRUD: Week 3-4 (API routes, validation)
- âœ… Transcription pipeline: Week 5-6 (Whisper integration)
- âœ… Medical records: Week 6-7 (GPT-4o, schema validation)
- âœ… FRED service: Week 7-8 (Gemini integration, grounding)
- âœ… Farejador: Week 8-9 (Gemini Grounding, CRON job)
- âœ… Billing: Week 9-10 (Stripe integration, webhooks)
- âœ… Optimization: Week 11-12 (caching, indexing, performance)


### Infrastructure

- âœ… VPS + Docker: Week 1 (Coolify setup)
- âœ… CI/CD: Week 2 (GitHub Actions)
- âœ… Monitoring: Week 11 (Sentry, uptime robot)
- âœ… Backup: Week 11 (CRON + B2)

***

## 14. Cost Breakdown (Monthly)

| Item | Cost (USD) | Notes |
| :-- | :-- | :-- |
| **Infrastructure** |  |  |
| VPS (8GB RAM, 160GB SSD) | \$15 | Hostinger |
| MinIO storage (self-hosted) | Free | Included in VPS |
| Backup (B2, 100GB) | \$0.50 | Very cheap |
| **APIs** |  |  |
| OpenAI (Whisper + GPT-4o) | \$10-15 | 500 consultations |
| Google Gemini | Free | <15k requests/day |
| Stripe (per transaction) | 2.9% + \$0.49 | Varies by revenue |
| **Monitoring** |  |  |
| Sentry (error tracking) | \$29 | Essential for production |
| UptimeRobot (uptime monitoring) | \$10 | Peace of mind |
| **Total Infrastructure** | **~\$65-80/month** | Scales with usage |
|  |  |  |
| **Per-Clinic Pricing** |  |  |
| STARTER | R\$ 99 | 50 consultations/mth |
| PROFESSIONAL | R\$ 199 | 200 consultations/mth |
| ENTERPRISE | R\$ 299 | Unlimited |
| **Gross Margin** (10 clinics) | ~R\$ 2.000/mth | 70%+ margin |


***

## 15. Conclusion \& Next Steps

### âœ… Architecture Complete

This architecture document provides:

- âœ… Complete system design (components, data flow, integrations)
- âœ… Technology stack justified (why each choice)
- âœ… Security \& compliance (LGPD, encryption, RBAC)
- âœ… Performance targets \& caching strategy
- âœ… Scalability path (up to 1000+ clinics)
- âœ… DevOps \& deployment (Docker, Coolify, CI/CD)
- âœ… Cost-effective infrastructure (~\$65/month base)
- âœ… Disaster recovery \& backup strategy
- âœ… Testing strategy \& quality gates

***

**Documento finalizado por:** Architect Alex (BMAD)
**Data:** 06 de Dezembro de 2025
**Status:** ğŸŸ¢ PRONTO PARA DESENVOLVIMENTO

**PrÃ³ximo:** PO (Product Owner) criar Master Checklist + Sharding
**ResponsÃ¡vel:** User (Dono Digital Dog) validar com Architect antes de passar PO